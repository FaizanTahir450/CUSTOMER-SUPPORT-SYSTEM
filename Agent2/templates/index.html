{% extends "base.html" %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- Header -->
    <header class="text-center mb-12">
        <h1
            class="text-4xl sm:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-cyan-400 mb-4">
            Hi! I'm Agent 2
        </h1>
        <p class="text-lg text-gray-400">
            SQL Agent
        </p>

        <!-- Status Indicators -->
        <div class="flex justify-center gap-6 mt-6">
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded-full {% if connection_status %}bg-green-500{% else %}bg-red-500{% endif %}">
                </div>
                <span class="text-sm text-gray-400">MySQL</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded-full {% if gemini_available %}bg-green-500{% else %}bg-red-500{% endif %}">
                </div>
                <span class="text-sm text-gray-400">Gemini API</span>
            </div>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Left Panel -->
        <div class="lg:col-span-1 space-y-8">
            <!-- Database Info -->
            <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                <h2 class="text-xl font-semibold mb-4 text-cyan-300 flex items-center">
                    <span class="text-2xl mr-2">üìä</span> Database Connection
                </h2>

                {% if connection_status %}
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Status:</span>
                        <span class="text-green-400 font-medium">Connected</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Database:</span>
                        <span class="text-gray-200">{{ config.MYSQL_DATABASE }}</span>
                    </div>
                </div>

                <button onclick="loadTables()"
                    class="w-full mt-4 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-500 transition-colors">
                    Load Tables
                </button>
                {% else %}
                <div class="text-red-400 text-center py-4">
                    ‚ùå Not connected to MySQL
                </div>
                {% endif %}
            </div>

            <!-- Tables List -->
            <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                <h2 class="text-xl font-semibold mb-4 text-cyan-300 flex items-center">
                    <span class="text-2xl mr-2">üóÉÔ∏è</span> Database Tables
                </h2>
                <div id="tables-list" class="max-h-96 overflow-y-auto">
                    <div class="text-gray-500 text-center py-8">
                        Click "Load Tables" to see database structure
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="lg:col-span-2">
            <!-- Query Input -->
            <div class="bg-gray-800 rounded-lg p-6 border border-gray-700 mb-8">
                <h2 class="text-xl font-semibold mb-4 text-cyan-300 flex items-center">
                    <span class="text-2xl mr-2">üí¨</span> Ask a Question
                </h2>

                <form id="query-form" class="space-y-4">
                    <div>
                        <textarea id="question-input"
                            placeholder="e.g., What are the top 5 customers by total order value?" rows="4"
                            class="w-full p-3 bg-gray-900 border border-gray-700 rounded-md focus:ring-2 focus:ring-cyan-500 focus:outline-none transition-all text-white"
                            required></textarea>
                    </div>

                    <button type="submit" id="submit-btn"
                        class="w-full bg-cyan-600 text-white font-bold py-3 px-4 rounded-md hover:bg-cyan-500 transition-all disabled:bg-gray-600 disabled:cursor-not-allowed flex items-center justify-center">
                        <span id="submit-text">Ask Agent 2</span>
                        <div id="loading-spinner" class="hidden ml-2">
                            <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                        </div>
                    </button>
                </form>
            </div>

            <!-- Results -->
            <div id="results-container" class="bg-gray-800 rounded-lg p-6 border border-gray-700 min-h-96 hidden">
                <!-- Results will be loaded here by JavaScript -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentTables = [];

    // Markdown rendering function
    function renderMarkdown(text) {
        if (!text) return '';

        // Simple markdown to HTML conversion
        let html = text
            // Convert line breaks
            .replace(/\n/g, '<br>')
            // Convert bold **text** and __text__
            .replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold">$1</strong>')
            .replace(/__(.*?)__/g, '<strong class="font-semibold">$1</strong>')
            // Convert italic *text* and _text_
            .replace(/\*(.*?)\*/g, '<em class="italic">$1</em>')
            .replace(/_(.*?)_/g, '<em class="italic">$1</em>')
            // Convert bullet points
            .replace(/^\s*[-*]\s+(.+)$/gm, '<li class="ml-4">$1</li>')
            // Wrap bullet points in ul
            .replace(/(<li class="ml-4">.*<\/li>)/s, '<ul class="list-disc list-inside space-y-1 my-2">$1</ul>')
            // Convert numbered lists
            .replace(/^\s*\d+\.\s+(.+)$/gm, '<li class="ml-4">$1</li>')
            // Wrap numbered lists in ol
            .replace(/(<li class="ml-4">.*<\/li>)/s, '<ol class="list-decimal list-inside space-y-1 my-2">$1</ol>');

        return html;
    }

    // Load tables from database
    async function loadTables() {
        try {
            const data = await apiCall('/api/tables');
            currentTables = data.tables;
            displayTables(currentTables);
        } catch (error) {
            alert('Error loading tables: ' + error.message);
        }
    }

    // Display tables in the tables list
    function displayTables(tables) {
        const container = document.getElementById('tables-list');

        if (tables.length === 0) {
            container.innerHTML = '<div class="text-gray-500 text-center py-8">No tables found</div>';
            return;
        }

        container.innerHTML = tables.map(table => `
            <div class="mb-4 last:mb-0 bg-gray-900 rounded-lg p-4 border border-gray-700">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="font-semibold text-cyan-300">${table.name}</h3>
                    <span class="text-xs text-gray-500 bg-gray-800 px-2 py-1 rounded">${table.sample_count} samples</span>
                </div>
                ${table.comment ? `<p class="text-sm text-gray-400 mb-2">${table.comment}</p>` : ''}
                
                ${table.sample_count > 0 ? `
                    <details class="text-sm">
                        <summary class="cursor-pointer text-gray-400 hover:text-gray-300">Sample data</summary>
                        <div class="mt-2 overflow-x-auto">
                            <table class="w-full text-xs border border-gray-700">
                                <thead class="bg-gray-800">
                                    <tr>
                                        ${Object.keys(table.sample_data[0]).map(col =>
            `<th class="p-2 text-left border-b border-gray-700">${col}</th>`
        ).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${table.sample_data.map(row => `
                                        <tr class="border-b border-gray-700">
                                            ${Object.values(row).map(val =>
            `<td class="p-2 border-r border-gray-700 last:border-r-0">${val}</td>`
        ).join('')}
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </details>
                ` : ''}
            </div>
        `).join('');
    }

    // Handle query form submission
    document.getElementById('query-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const question = document.getElementById('question-input').value.trim();
        const submitBtn = document.getElementById('submit-btn');
        const submitText = document.getElementById('submit-text');
        const loadingSpinner = document.getElementById('loading-spinner');

        if (!question) return;

        // Show loading state
        submitBtn.disabled = true;
        submitText.textContent = 'Processing...';
        loadingSpinner.classList.remove('hidden');

        try {
            const data = await apiCall('/api/query', {
                method: 'POST',
                body: JSON.stringify({ question })
            });

            displayResults(data, question);

        } catch (error) {
            alert('Error: ' + error.message);
        } finally {
            // Reset loading state
            submitBtn.disabled = false;
            submitText.textContent = 'Ask Agent 2';
            loadingSpinner.classList.add('hidden');
        }
    });

    // Display query results - UPDATED FOR NEW RESPONSE FORMAT
    function displayResults(data, originalQuestion) {
        const container = document.getElementById('results-container');
        container.classList.remove('hidden');

        let resultsHtml = '';

        if (data.error) {
            resultsHtml = `
                <div class="bg-red-900/50 border border-red-700 rounded-md p-4 text-red-300">
                    <h3 class="font-semibold mb-2">Error</h3>
                    <p>${data.error}</p>
                    ${data.generated_sql ? `
                        <div class="mt-4">
                            <h4 class="font-semibold mb-2">Generated SQL:</h4>
                            <pre class="bg-gray-900 p-3 rounded text-sm overflow-x-auto"><code>${data.generated_sql}</code></pre>
                        </div>
                    ` : ''}
                </div>
            `;
        }
        // Handle conversation responses (greetings, small talk, etc.)
        else if (data.type === 'conversation') {
            resultsHtml = `
                <div class="space-y-6">
                    <!-- Conversation Response -->
                    <div>
                        <h3 class="text-lg font-semibold mb-2 text-purple-300">üí¨ Agent 2 says:</h3>
                        <div class="p-4 bg-gray-900/70 rounded-md border border-gray-700">
                            <div class="text-gray-200 max-w-none">
                                ${renderMarkdown(data.message)}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Original Question -->
                    <div class="text-sm text-gray-400">
                        <strong>Your question:</strong> "${originalQuestion}"
                    </div>
                </div>
            `;
        }
        // Handle SQL query results
        else if (data.type === 'sql_result') {
            resultsHtml = `
                <div class="space-y-6">
                    <!-- Natural Language Answer -->
                    <div>
                        <h3 class="text-lg font-semibold mb-2 text-purple-300">Natural Language Answer</h3>
                        <div class="p-4 bg-gray-900/70 rounded-md border border-gray-700">
                            <div class="text-gray-200 max-w-none">
                                ${renderMarkdown(data.explanation)}
                            </div>
                        </div>
                    </div>

                    <!-- Generated SQL -->
                    <div>
                        <h3 class="text-lg font-semibold mb-2 text-purple-300">Generated SQL Query</h3>
                        <div class="p-4 bg-gray-900 rounded-md font-mono text-sm text-cyan-300 overflow-x-auto border border-gray-700">
                            <pre><code>${data.generated_sql}</code></pre>
                        </div>
                    </div>
                    
                    <!-- Query Results -->
                    ${data.results && data.results.length > 0 ? `
                        <div>
                            <h3 class="text-lg font-semibold mb-2 text-purple-300">
                                Query Results (${data.results_count} rows)
                            </h3>
                            <div class="border border-gray-700 rounded-lg overflow-hidden">
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-700 bg-gray-900">
                                        <thead class="bg-gray-800">
                                            <tr>
                                                ${Object.keys(data.results[0]).map(col =>
                `<th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">${col}</th>`
            ).join('')}
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-gray-700">
                                            ${data.results.map((row, i) => `
                                                <tr class="hover:bg-gray-800/50">
                                                    ${Object.values(row).map(val =>
                `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-200">${val}</td>`
            ).join('')}
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    ` : '<p class="text-gray-400 text-center py-8">No results returned</p>'}
                </div>
            `;
        }
        // Handle SQL errors
        else if (data.type === 'sql_error') {
            resultsHtml = `
                <div class="bg-red-900/50 border border-red-700 rounded-md p-4 text-red-300">
                    <h3 class="font-semibold mb-2">SQL Execution Error</h3>
                    <p>${data.error}</p>
                    ${data.generated_sql ? `
                        <div class="mt-4">
                            <h4 class="font-semibold mb-2">Generated SQL:</h4>
                            <pre class="bg-gray-900 p-3 rounded text-sm overflow-x-auto"><code>${data.generated_sql}</code></pre>
                        </div>
                    ` : ''}
                </div>
            `;
        }
        // Handle unexpected response types
        else {
            resultsHtml = `
                <div class="bg-yellow-900/50 border border-yellow-700 rounded-md p-4 text-yellow-300">
                    <h3 class="font-semibold mb-2">Unexpected Response</h3>
                    <p>Received an unexpected response format from the server.</p>
                    <pre class="mt-2 bg-gray-900 p-3 rounded text-sm overflow-x-auto">${JSON.stringify(data, null, 2)}</pre>
                </div>`
            ;
        }

        container.innerHTML = resultsHtml;
    }

    // Load tables on page load if connected
    document.addEventListener('DOMContentLoaded', () => {
        {% if connection_status %}
        loadTables();
        {% endif %}
    });
</script>
{% endblock %}